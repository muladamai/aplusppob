<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aplus Digital - Data Reload</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f3f4f6;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
      }
      .product-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .product-card:active {
        transform: scale(0.98);
      }
      .product-list::-webkit-scrollbar {
        width: 4px;
      }
      .product-list::-webkit-scrollbar-track {
        background: transparent;
      }
      .product-list::-webkit-scrollbar-thumb {
        background: #e5e7eb;
        border-radius: 10px;
      }
      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in {
        animation: fade-in 0.3s ease-out forwards;
      }
    </style>
  </head>
  <body class="flex justify-center min-h-screen">
    <div class="w-full max-w-md bg-white shadow-lg min-h-screen flex flex-col">
      <!-- Header -->
      <header class="bg-blue-600 p-4 text-white">
        <h1 class="text-xl font-bold text-center">Aplus Digital</h1>
      </header>

      <!-- Tabs -->
      <div class="flex border-b border-gray-200">
        <button
          id="tab-masa-aktif"
          onclick="switchTab('masa aktif')"
          class="w-1/2 py-3 text-sm font-semibold border-b-2 border-blue-600 text-blue-600 transition-all"
        >
          Masa Aktif
        </button>
        <button
          id="tab-paket-data"
          onclick="switchTab('paket data')"
          class="w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all"
        >
          Paket Data
        </button>
      </div>

      <!-- Phone Number Input Section -->
      <div class="p-4 bg-gray-50 border-b border-gray-100">
        <label
          class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider"
          >Nomor Handphone</label
        >
        <div
          class="relative flex items-center bg-white border-2 border-gray-200 rounded-xl px-4 py-3 focus-within:border-blue-500 transition-colors"
        >
          <i class="fa-solid fa-mobile-screen-button text-gray-400 mr-3"></i>
          <input
            type="tel"
            id="phone-number"
            placeholder="Contoh: 0812xxxx"
            class="w-full outline-none text-lg font-medium tracking-wide"
            oninput="handlePhoneInput(this.value)"
          />
          <div
            id="operator-badge"
            class="hidden ml-2 px-2 py-1 rounded text-[10px] font-bold text-white uppercase"
          >
            Provider
          </div>
        </div>
        <p
          id="operator-info"
          class="text-[11px] mt-2 text-gray-400 font-medium h-4"
        >
          Masukkan nomor untuk melihat produk
        </p>
      </div>

      <!-- Product List -->
      <div
        id="product-container"
        class="flex-1 p-4 product-list overflow-y-auto"
      >
        <div
          id="loading-state"
          class="hidden flex flex-col items-center justify-center h-64 text-gray-400"
        >
          <div
            class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"
          ></div>
          <p class="text-sm">Mengambil data produk...</p>
        </div>
        <div
          id="empty-state"
          class="flex flex-col items-center justify-center h-64 text-gray-400"
        >
          <i class="fa-solid fa-receipt text-5xl mb-4 opacity-20"></i>
          <p class="text-sm">Pilih provider dengan memasukkan nomor HP</p>
        </div>
        <div id="product-list" class="grid gap-3 hidden">
          <!-- Products injected here -->
        </div>
      </div>

      <!-- Success Message / Confirm -->
      <div
        id="success-overlay"
        class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-6"
      >
        <div
          class="bg-white rounded-2xl p-6 w-full max-w-xs text-center relative animate-fade-in"
        >
          <button
            onclick="closeOverlay()"
            class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors"
          >
            <i class="fa-solid fa-xmark text-gray-400 text-xl"></i>
          </button>

          <div id="confirm-view">
            <div
              class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fa-solid fa-cart-shopping text-2xl"></i>
            </div>
            <h3 class="font-bold text-lg">Konfirmasi Pembelian</h3>
            <p
              id="selected-product-text"
              class="text-gray-500 text-sm mt-2"
            ></p>
            <button
              id="process-btn"
              onclick="processOrder()"
              class="mt-6 w-full bg-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center"
            >
              <span>Lanjutkan</span>
            </button>
          </div>

          <div id="order-success-view" class="hidden">
            <div
              class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fa-solid fa-check text-2xl"></i>
            </div>
            <h3 class="font-bold text-lg text-green-600">Pesanan Berhasil!</h3>
            <div
              class="mt-4 p-3 bg-gray-50 rounded-lg text-left text-xs space-y-2"
            >
              <p>
                <span class="text-gray-400">Kode Pesanan:</span> <br /><strong
                  id="display-order-id"
                  class="text-blue-600 text-sm"
                ></strong>
              </p>
              <p>
                <span class="text-gray-400">Status:</span>
                <strong class="text-orange-500">NEW</strong>
              </p>
            </div>
            <p class="text-gray-500 text-[11px] mt-4">
              Pesanan Anda telah dicatat. Anda akan diarahkan ke WhatsApp untuk
              penyelesaian pembayaran.
            </p>
            <button
              onclick="redirectToWA()"
              class="mt-6 w-full bg-green-500 text-white py-3 rounded-xl font-bold"
            >
              Chat WhatsApp
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbyg6dhzBkR0Sw_tGEoK_NtfCN7XciOKBUKn8dELL8gj4RN5nLsHjLMUVzKFpwmxUK8yZA/exec";
      const API_URL2 =
        "https://script.google.com/macros/s/AKfycbxlcGpvmgZiccu2St6y6q1fZSX4mfuFyLuxML-3AX8DK4Gtk7LuoW0ssybDiSs_9w7B/exec";

      const providersConfig = {
        telkomsel: {
          prefixes: [
            "0811",
            "0812",
            "0813",
            "0821",
            "0822",
            "0823",
            "0851",
            "0852",
            "0853",
          ],
          color: "bg-red-600",
        },
        indosat: {
          prefixes: ["0814", "0815", "0816", "0855", "0856", "0857", "0858"],
          color: "bg-yellow-400",
        },
        xl: {
          prefixes: ["0817", "0818", "0819", "0859", "0877", "0878"],
          color: "bg-blue-700",
        },
        axis: { prefixes: ["0831", "0832", "0838"], color: "bg-purple-600" },
        tri: {
          prefixes: ["0895", "0896", "0897", "0898", "0899"],
          color: "bg-orange-600",
        },
        smartfren: {
          prefixes: [
            "0881",
            "0882",
            "0884",
            "0885",
            "0886",
            "0887",
            "0888",
            "0889",
          ],
          color: "bg-pink-600",
        },
      };

      let allProducts = [];
      let currentTab = "masa aktif";
      let detectedProvider = null;
      let isLoading = false;
      let selectedProductData = null;

      const CACHE_DURATION = 60 * 60 * 1000;
      const CACHE_KEY_PREFIX = "reload_data_";
      const TELEGRAM_BOT_TOKEN =
        "1179842075:AAG5rAwWr8EJZ3kn1onmMHp9ghQqjRP23hQ";
      const TELEGRAM_CHAT_ID = "-5119282826";

      function saveToCache(provider, data) {
        try {
          const cacheData = { timestamp: Date.now(), data: data };
          localStorage.setItem(
            `${CACHE_KEY_PREFIX}${provider}`,
            JSON.stringify(cacheData)
          );
        } catch (e) {
          console.error(e);
        }
      }

      function getFromCache(provider) {
        try {
          const cached = localStorage.getItem(`${CACHE_KEY_PREFIX}${provider}`);
          if (!cached) return null;
          const cacheData = JSON.parse(cached);
          if (Date.now() - cacheData.timestamp < CACHE_DURATION)
            return cacheData.data;
          return null;
        } catch (e) {
          return null;
        }
      }

      async function fetchProductsByProvider(provider) {
        if (!provider) return;
        const cachedData = getFromCache(provider);
        if (cachedData) {
          allProducts = cachedData;
          renderProducts();
          return;
        }
        isLoading = true;
        document.getElementById("loading-state").classList.remove("hidden");
        document.getElementById("empty-state").classList.add("hidden");
        document.getElementById("product-list").classList.add("hidden");
        try {
          const response = await fetch(
            `${API_URL}?provider=${encodeURIComponent(provider)}`
          );
          const result = await response.json();
          if (result.status === "ok") {
            allProducts = result.data || [];
            saveToCache(provider, allProducts);
            renderProducts();
          } else {
            showEmpty("Produk belum tersedia");
          }
        } catch (error) {
          showEmpty("Gagal mengambil data");
        } finally {
          document.getElementById("loading-state").classList.add("hidden");
          isLoading = false;
        }
      }

      function showEmpty(message) {
        const empty = document.getElementById("empty-state");
        const list = document.getElementById("product-list");
        empty.innerHTML = `<i class="fa-solid fa-box-open text-5xl mb-4 opacity-20"></i><p class="text-sm">${message}</p>`;
        empty.classList.remove("hidden");
        list.classList.add("hidden");
      }

      function switchTab(tab) {
        currentTab = tab;
        const btnMasa = document.getElementById("tab-masa-aktif");
        const btnPaket = document.getElementById("tab-paket-data");
        if (tab === "masa aktif") {
          btnMasa.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-blue-600 text-blue-600 transition-all";
          btnPaket.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
        } else {
          btnPaket.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-blue-600 text-blue-600 transition-all";
          btnMasa.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
        }
        renderProducts();
      }

      function handlePhoneInput(val) {
        val = val.replace(/\D/g, "");
        document.getElementById("phone-number").value = val;
        renderProducts();
        if (val.length >= 4) {
          const prefix = val.substring(0, 4);
          let found = null;
          for (const [name, config] of Object.entries(providersConfig)) {
            if (config.prefixes.includes(prefix)) {
              found = name;
              break;
            }
          }
          if (found) {
            if (detectedProvider !== found) {
              detectedProvider = found;
              updateUIForProvider(found);
              fetchProductsByProvider(found);
            }
          } else {
            resetState("Prefix tidak dikenal");
          }
        } else {
          resetState("Masukkan nomor untuk melihat produk");
        }
      }

      function updateUIForProvider(name) {
        const info = document.getElementById("operator-info");
        const badge = document.getElementById("operator-badge");
        const config = providersConfig[name];
        info.innerHTML = `<span class="text-blue-600 font-bold">Operator Terdeteksi: ${name.toUpperCase()}</span>`;
        badge.innerText = name;
        badge.className = `ml-2 px-2 py-1 rounded text-[10px] font-bold text-white uppercase ${config.color}`;
        badge.style.display = "block";
      }

      function resetState(message) {
        detectedProvider = null;
        allProducts = [];
        document.getElementById("operator-badge").style.display = "none";
        document.getElementById("operator-info").innerText = message;
        showEmpty("Pilih provider dengan memasukkan nomor HP");
      }

      function renderProducts() {
        if (!detectedProvider || !allProducts.length) return;
        const container = document.getElementById("product-list");
        const empty = document.getElementById("empty-state");
        const phoneNumber = document.getElementById("phone-number").value;
        const isPhoneValid = phoneNumber.length >= 11;
        container.innerHTML = "";
        const filteredProducts = allProducts.filter(
          (p) =>
            String(p.operator || "")
              .toLowerCase()
              .trim() === detectedProvider.toLowerCase() &&
            String(p.type || "")
              .toLowerCase()
              .trim() === currentTab
        );
        if (!filteredProducts.length) {
          showEmpty("Produk belum tersedia");
          return;
        }
        filteredProducts.forEach((product) => {
          const card = document.createElement("div");
          card.className = `product-card bg-white border border-gray-100 rounded-xl p-4 flex justify-between items-center shadow-sm cursor-pointer hover:border-blue-300 ${
            !isPhoneValid ? "opacity-80" : ""
          }`;
          card.onclick = () => {
            if (document.getElementById("phone-number").value.length >= 11) {
              selectProduct(product);
            } else {
              const info = document.getElementById("operator-info");
              info.innerHTML = `<span class="text-red-500 font-bold animate-pulse">Lengkapi nomor HP (min. 11 digit)!</span>`;
              setTimeout(() => updateUIForProvider(detectedProvider), 2000);
            }
          };
          const formattedPrice = new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            maximumFractionDigits: 0,
          }).format(product.price);
          card.innerHTML = `<div><div class="flex items-center gap-2 mb-1"><span class="font-bold text-gray-800">${
            product.description
          }</span>${
            product.label
              ? `<span class="bg-blue-100 text-blue-600 text-[9px] px-2 py-0.5 rounded-full font-bold uppercase">${product.label}</span>`
              : ""
          }</div><span class="text-blue-600 font-bold text-sm">${formattedPrice}</span></div><i class="fa-solid fa-chevron-right text-gray-300 text-sm"></i>`;
          container.appendChild(card);
        });
        empty.classList.add("hidden");
        container.classList.remove("hidden");
      }

      function selectProduct(product) {
        const phoneNumber = document.getElementById("phone-number").value;
        const formattedPrice = new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          maximumFractionDigits: 0,
        }).format(product.price);
        selectedProductData = {
          phone: phoneNumber,
          description: product.description,
          price: product.price,
          formattedPrice: formattedPrice,
          provider: detectedProvider,
          sku: product.SKU || "N/A",
        };
        document.getElementById(
          "selected-product-text"
        ).innerText = `${product.description} - ${formattedPrice}`;
        document.getElementById("confirm-view").classList.remove("hidden");
        document.getElementById("order-success-view").classList.add("hidden");
        document.getElementById("success-overlay").classList.remove("hidden");
      }

      function generateOrderId() {
        const now = new Date();
        const timestamp = now.getTime().toString();
        // Generate a 9-digit suffix from timestamp and a random part
        const hash = timestamp.slice(-9) + Math.floor(Math.random() * 100);
        return "WO-" + hash.slice(0, 10);
      }

      async function sendToTelegram(data) {
        const message = `*Pesanan Baru*\n\nOrder ID: \`${
          data.orderId
        }\`\nNomor: ${data.phone}\nProduk: ${data.description}\nSKU: ${
          data.sku
        }\nHarga: ${
          data.formattedPrice
        }\nProvider: ${data.provider.toUpperCase()}`;
        try {
          await fetch(
            `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: "Markdown",
              }),
            }
          );
        } catch (e) {}
      }

      async function insertToSheet(data) {
        try {
          // Payload structure for Google Sheet insert
          const payload = {
            action: "insertOrder",
            nomor_tujuan: data.phone,
            kode_produk: data.sku,
            harga: data.price,
            nomor_order: data.orderId,
            status: "new",
          };

          await fetch(API_URL2, {
            method: "POST",
            mode: "no-cors", // Standard for simple Apps Script POST if not handling response
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          return true;
        } catch (e) {
          return false;
        }
      }

      async function processOrder() {
        if (!selectedProductData || isLoading) return;

        isLoading = true;
        const btn = document.getElementById("process-btn");
        btn.innerHTML =
          '<i class="fa-solid fa-circle-notch animate-spin mr-2"></i> Memproses...';
        btn.disabled = true;

        const orderId = generateOrderId();
        selectedProductData.orderId = orderId;

        // Run processes
        await Promise.all([
          //sendToTelegram(selectedProductData),
          insertToSheet(selectedProductData),
        ]);

        // Update UI to success view
        document.getElementById("confirm-view").classList.add("hidden");
        document
          .getElementById("order-success-view")
          .classList.remove("hidden");
        document.getElementById("display-order-id").innerText = orderId;

        isLoading = false;
        btn.innerHTML = "Lanjutkan";
        btn.disabled = false;
      }

      function redirectToWA() {
        if (!selectedProductData) return;
        const data = selectedProductData;
        const message = `Halo Aplus Digital, saya ingin bayar pesanan:\n\nOrder ID: ${data.orderId}\nNomor: ${data.phone}\nProduk: ${data.description}\nHarga: ${data.formattedPrice}`;
        const whatsappNumber = "6287862425338";
        window.open(
          `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`,
          "_blank"
        );
        closeOverlay();
      }

      function closeOverlay() {
        document.getElementById("success-overlay").classList.add("hidden");
        if (
          document
            .getElementById("order-success-view")
            .classList.contains("hidden")
        ) {
          // Only clear if we didn't finish an order
          selectedProductData = null;
        }
      }
    </script>
  </body>
</html>
