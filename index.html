<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aplus Digital - Data Reload</title>
    <!-- //270126 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="https://cdn.jsdelivr.net/npm/flowbite@4.0.1/dist/flowbite.min.css" rel="stylesheet" />
    <style>
      body {
        background-color: #f3f4f6;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
      }
      /* Default styles for all devices (mobile-first) */
    .max-w-lg {
    min-width: 12rem;
}
    
    /* Medium devices (tablets, 768px and up) */
    @media (min-width: 768px) {
      .max-w-lg {
    min-width: 32rem;
}
    }
.input-fixed {
  position: fixed;
  top: 0px;
  left: 0;
  right: 0;
  background: white;
  z-index: 50;
  box-shadow: 0px 2px rgba(0, 0, 0, 0.1);
  max-width: 32rem;
  margin: 0 auto;
  padding: 20px 10px;
}
.input-fixed .mb-10 {
    margin-bottom: 0.5rem;
}
section {
    display: block;
    unicode-bidi: isolate;
}
.container {
    width: 100%;
    @media (width >= 540px) {
      max-width: 540px;
    }
    @media (width >= 768px) {
      max-width: 768px;
    }
    @media (width >= 992px) {
      max-width: 992px;
    }
    @media (width >= 1140px) {
      max-width: 1140px;
    }
    @media (width >= 1320px) {
      max-width: 1320px;
    }
  }
  .container {
    margin-inline: auto;
    padding-inline: 1rem;
  }
  .text-base {
    font-size: var(--text-base);
    line-height: var(--tw-leading, var(--text-base--line-height));
}
/* Add padding when fixed to prevent content jump */
#emoney-page.input-is-fixed #product-grid {
  padding-top: 200px; /* Adjust based on input section height */
}
#promo-carousel {
    touch-action: pan-y pinch-zoom; /* Allows vertical scrolling, enables horizontal swipe */
    user-select: none; /* Prevents text selection during swipe */
    -webkit-user-select: none;
    -webkit-touch-callout: none; /* Prevents iOS callout menu */
}

.carousel-inner {
    will-change: transform; /* Better performance for animations */
}

.carousel-item img {
    pointer-events: none; /* Prevents image drag interference */
}
.tabs-fixed {
    display: inline;
    position: relative;
    top: -12px;
    right: 10px;
}
@keyframes bounce {
  0%, 100% {
    transform: translateY(-25%);
    animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
  }
  50% {
    transform: translateY(0);
    animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
  }
}
div#empty-state {
    height: 100px;
}
.new-badge {
  display: inline-block;
  animation: bounce 1s infinite;
}

      .product-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .product-card:active {
        transform: scale(0.98);
      }
      .product-list::-webkit-scrollbar {
        width: 4px;
      }
      .product-list::-webkit-scrollbar-track {
        background: transparent;
      }
      .product-list::-webkit-scrollbar-thumb {
        background: #e5e7eb;
        border-radius: 10px;
      }
      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in {
        animation: fade-in 0.3s ease-out forwards;
      }
    </style>
  </head>
  <body class="flex justify-center min-h-screen">
    <div class="w-full max-w-lg bg-white shadow-lg min-h-screen flex flex-col">
      <!-- Header -->
      <header class="bg-[#3c3aff] p-4 text-white">
        <h1 class="text-xl font-bold text-center">Aplus Digital</h1>
      </header>

      <!-- Tabs -->
      <div class="flex border-b border-gray-200">
        <button id="tab-masa-aktif" onclick="switchTab('masa aktif')" class="w-1/2 py-3 text-sm font-semibold border-b-2 border-blue-600 text-blue-600 transition-all">
          Masa Aktif
        </button>
        <button id="tab-paket-data" onclick="switchTab('paket data')" class="w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all">
          Paket Data
        </button>
        <button id="tab-pulsa" onclick="switchTab('pulsa')" class="w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all" >
          Pulsa
        </button>
        <button id="tab-emoney" onclick="switchTab('emoney')" class=" w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all"  >
          E-Money
          <span class="tabs-fixed new-badge ml-1 bg-yellow-400 text-black text-[10px] px-2 py-0.5 rounded-full font-bold uppercase">Baru</span>
        </button>
      </div>
      
<!-- Simple Custom Carousel with Real Images -->
<div id="promo-carousel" class="relative w-full h-48 overflow-hidden">
    <div class="carousel-inner flex transition-transform duration-500 ease-in-out h-full" id="carousel-track">
        <!-- Slide 1 -->
        <div class="carousel-item min-w-full h-full relative">
            <img src="https://easygoing-pig.static.domains/1.jpg" class="w-full h-full object-cover" alt="Promo 1">
            <div class="absolute inset-0 bg-black/40 flex items-center text-white">
                <div class="text-left p-6 pl-8">
                    <h3 class="text-2xl font-bold mb-2">Promo Super Murah!</h3>
                    <p class="text-sm">Dapatkan bonus untuk setiap pembelian</p>
                </div>
            </div>
        </div>
        <!-- Slide 2 -->
        <div class="carousel-item min-w-full h-full relative">
            <img src="https://easygoing-pig.static.domains/2.jpg" class="w-full h-full object-cover" alt="Promo 2">
            <div class="absolute inset-0 bg-black/40 flex items-center text-white">
                <div class="text-left p-6 pl-8">
                    <h3 class="text-2xl font-bold mb-2">Spesial Diskon</h3>
                    <p class="text-sm">Untuk pembelian pulsa minimal 50rb</p>
                </div>
            </div>
        </div>
        <!-- Slide 3 -->
        <div class="carousel-item min-w-full h-full relative">
            <img src="https://easygoing-pig.static.domains/3.jpg" class="w-full h-full object-cover" alt="Promo 3">
            <div class="absolute inset-0 bg-black/40 flex items-center text-white">
                <div class="text-left p-6 pl-8">
                    <h3 class="text-2xl font-bold mb-2">Topup Driver</h3>
                    <p class="text-sm">Proses otomatis dalam hitungan detik</p>
                </div>
            </div>
        </div>
        <!-- Slide 4 -->
        <div class="carousel-item min-w-full h-full relative">
            <img src="https://easygoing-pig.static.domains/Super.jpg" class="w-full h-full object-cover" alt="Promo 3">
            <div class="absolute inset-0 bg-black/40 flex items-center text-white">
                <div class="text-left p-6 pl-8">
                    <h3 class="text-2xl font-bold mb-2">Topup Game</h3>
                    <p class="text-sm">Segera hadir!</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Indicators -->
    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2 z-10">
        <button class="carousel-dot w-2 h-2 rounded-full bg-white" data-index="0"></button>
        <button class="carousel-dot w-2 h-2 rounded-full bg-white/50" data-index="1"></button>
        <button class="carousel-dot w-2 h-2 rounded-full bg-white/50" data-index="2"></button>
        <button class="carousel-dot w-2 h-2 rounded-full bg-white/50" data-index="3"></button>
    </div>
    <!-- Navigation Arrows -->
    <!-- <button class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/40 p-2 rounded-full backdrop-blur-sm transition-all z-10" onclick="prevSlide()">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
    </button>
    <button class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/40 p-2 rounded-full backdrop-blur-sm transition-all z-10" onclick="nextSlide()">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
    </button> -->
</div>

      <!-- Phone Number Input Section -->
      <div id="phone-input-section" class="p-4 bg-gray-50 border-b border-gray-100">
        <label
          class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider"
          >Nomor Handphone</label
        >
        <div
          class="relative flex items-center bg-white border-2 border-gray-200 rounded-xl px-4 py-3 focus-within:border-blue-500 transition-colors"
        >
          <i class="fa-solid fa-mobile-screen-button text-gray-400 mr-3"></i>
          <input
            type="tel"
            id="phone-number"
            placeholder="Contoh: 0812xxxx"
            class="w-full outline-none text-lg font-medium tracking-wide"
            oninput="handlePhoneInput(this.value)"
          />
          <div
            id="operator-badge"
            class="hidden ml-2 px-2 py-1 rounded text-[10px] font-bold text-white uppercase"
          >
            Provider
          </div>
        </div>
        <p
          id="operator-info"
          class="text-[11px] mt-2 text-gray-400 font-medium h-4"
        >
          Masukkan nomor untuk melihat produk
        </p>
      </div>

     
      <div id="emoney-page" class="p-4 hidden">
        <!-- Step 1: Operator Buttons -->
        <!-- Operator Buttons Section -->
        <div id="operator-section" class="mb-6">
            <div class="flex gap-4">
                <button onclick="handleOperatorClick('Grab Drive')" id="btn-grab"
                    class="operator-btn bg-[#2ecc71] text-black px-6 py-2 rounded-lg font-bold shadow-sm border border-gray-200">
                    Grab Driver
                </button>
                <button onclick="handleOperatorClick('Maxim Driver')" id="btn-maxim"
                    class="operator-btn bg-[#f1c40f] text-black px-6 py-2 rounded-lg font-bold shadow-sm border border-gray-200">
                    Maxim Driver
                </button>
            </div>
        </div>
        <!-- Step 2: Product Grid -->
            <div id="product-section" class="hidden">
                <!-- Step 3: Input ID -->
                <div id="input-section" class="hidden border-t pt-6">
                    <label class="block text-sm font-bold uppercase tracking-wide mb-2">Nomor ID Driver</label>
                    <input type="text" 
                           id="driver-id" 
                           placeholder="Masukkan ID" 
                           class="w-full p-4 border-2 border-black rounded-xl text-xl focus:outline-none"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    <p class="text-sm text-gray-500 mt-2">Masukkan angka saja</p>
                    
                    <button id="process-btn" onclick="initiateCheckout()" class="w-full mt-6 bg-black text-white py-4 rounded-xl font-bold text-lg mb-10">
                        Lanjutkan
                    </button>
                </div>
                <div id="product-grid" class="grid grid-cols-2 gap-3 mb-6">
                    <!-- Products will be injected here -->
                </div>

                
            </div>
        </div>
      <!-- Product List -->
      <div
        id="product-container"
        class="flex-1 p-4 product-list overflow-y-auto"
      >
        <div
          id="loading-state"
          class="hidden flex flex-col items-center justify-center h-64 text-gray-400"
        >
          <div
            class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"
          ></div>
          <p class="text-sm">Mengambil data produk...</p>
        </div>
        <div
          id="empty-state"
          class="flex flex-col items-center justify-center h-64 text-gray-400"
        >
          <i class="fa-solid fa-receipt text-5xl mb-4 opacity-20"></i>
          <p class="text-sm">Pilih provider dengan memasukkan nomor HP</p>
        </div>
        <div id="product-list" class="grid gap-3 hidden">
          <!-- Products injected here -->
        </div>
      </div>
       <section id="section-landing" class="pt-[20px]">
      <div class="container">
        <div class="flex flex-wrap items-center -mx-4">
          <div class="w-full px-4 lg:w-1/2">
            <div class="text-center mb-14 lg:mb-0 wow fadeInUp" data-wow-delay=".2s" style="visibility: visible; animation-delay: 0.2s;">
              <img src="https://easygoing-pig.static.domains/steps.jpg" alt="image" class="max-full">
            </div>
          </div>
          <div class="w-full px-4 lg:w-1/2">
            <div class="max-w-[485px] lg:ml-auto wow fadeInUp" data-wow-delay=".3s" style="visibility: visible; animation-delay: 0.3s;">
              <span class="block mb-2 text-base font-bold text-primary"> Aplus Digital </span>
              <h4 class="mb-6 text-3xl font-extrabold leading-tight text-black sm:text-2xl">Top Up Instan. Hemat Waktu Anda.</h4>
              <p class="mb-8 text-sm leading-relaxed text-body-color lg:mb-10">
               Masukkan nomor ponsel. Pilih paket data atau masa aktif. Bayar langsung dengan QRIS.
                Sistem memproses otomatis dalam hitungan detik.
                Tanpa login. Tanpa langkah tambahan.
                Cocok untuk kebutuhan cepat kapan saja.
              </p>
              <a href="https://wa.me/6287862425338?text=Hi+*Aplus*%21+mau+tanya+soal+pulsa+paket+data" class="inline-flex items-center text-base font-bold text-primary hover:underline">
                Hubungi CS

                <span class="pl-2">
                  <svg width="28" height="28" viewBox="0 0 28 28" class="fill-current">
                    <path d="M16.3333 19.7633V15.0967H5.92666L5.89166 12.7517H16.3333V8.09668L22.1667 13.93L16.3333 19.7633Z"></path>
                  </svg>
                </span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>

      <!-- Success Message / Confirm -->
      <div
        id="success-overlay"
        class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-6"
      >
        <div
          class="bg-white rounded-2xl p-6 w-full max-w-xs text-center relative animate-fade-in"
        >
          <button
            onclick="closeOverlay()"
            class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors"
          >
            <i class="fa-solid fa-xmark text-gray-400 text-xl"></i>
          </button>

          <div id="confirm-view">
            <div
              class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fa-solid fa-cart-shopping text-2xl"></i>
            </div>
            <h3 class="font-bold text-lg">Konfirmasi Pembelian</h3>
            <p
              id="selected-product-text"
              class="text-gray-500 text-sm mt-2"
            ></p>
            <button
              id="process-btn"
              gtm="gtm-buy"
              onclick="processOrder()"
              class="mt-6 w-full bg-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center"
            >
              <span>Lanjutkan</span>
            </button>
          </div>

          <!-- <div id="order-success-view" class="hidden">
            <div
              class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fa-solid fa-check text-2xl"></i>
            </div>
            <h3 class="font-bold text-lg text-green-600">Pesanan Berhasil!</h3>
            <div
              class="mt-4 p-3 bg-gray-50 rounded-lg text-left text-xs space-y-2"
            >
              <p>
                <span class="text-gray-400">Kode Pesanan:</span> <br /><strong
                  id="display-order-id"
                  class="text-blue-600 text-sm"
                ></strong>
              </p>
              <p>
                <span class="text-gray-400">Status:</span>
                <strong class="text-orange-500">NEW</strong>
              </p>
            </div>
            <p class="text-gray-500 text-[11px] mt-4">
              Pesanan Anda telah dicatat. Anda akan diarahkan ke WhatsApp untuk
              penyelesaian pembayaran.
            </p>
            <button
              onclick="redirectToWA()"
              class="mt-6 w-full bg-green-500 text-white py-3 rounded-xl font-bold"
            >
              Chat WhatsApp
            </button>
         </div> -->
          <div id="order-success-view" class="hidden">
            <div
              class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fa-solid fa-check text-2xl"></i>
            </div>
            <h3 class="font-bold text-lg text-green-600">Pesanan Berhasil!</h3>

            <p class="text-gray-500 text-[11px] mt-2">
              Pesanan Anda telah dicatat. Silakan cek detail untuk melakukan
              pembayaran.
            </p>

            <div class="mt-6 space-y-3">
              <button
                onclick="showOrderDetail()"
                class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center"
              >
                <i class="fa-solid fa-receipt mr-2"></i> Cek / Bayar Pesanan
              </button>

              <button
                onclick="redirectToWA()"
                class="w-full bg-green-500 text-white py-3 rounded-xl font-bold flex items-center justify-center"
              >
                <i class="fa-brands fa-whatsapp mr-2"></i> Chat WhatsApp
              </button>
            </div>
          </div>
          <div
            id="detail-overlay"
            class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[60] p-6"
          >
            <div
              class="bg-white rounded-2xl p-6 w-full max-w-xs relative animate-fade-in"
            >
              <button
                onclick="closeDetail()"
                class="absolute top-4 right-4 text-gray-400"
              >
                <i class="fa-solid fa-xmark text-xl"></i>
              </button>

              <h3 class="font-bold text-lg mb-4 text-center">Detail Pesanan</h3>

              <div class="space-y-3 text-sm border-t border-b py-4">
                <div class="flex justify-between">
                  <span class="text-gray-400">Order ID:</span>
                  <span id="det-id" class="font-bold text-blue-600"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Nomor:</span>
                  <span id="det-phone" class="font-bold"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Produk:</span>
                  <span
                    id="det-product"
                    class="font-bold text-right ml-2"
                  ></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Total Bayar:</span>
                  <span
                    id="det-price"
                    class="font-bold text-blue-600 text-lg"
                  ></span>
                </div>
              </div>

              <div id="det-payment-area" class="mt-6"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbyg6dhzBkR0Sw_tGEoK_NtfCN7XciOKBUKn8dELL8gj4RN5nLsHjLMUVzKFpwmxUK8yZA/exec";
      const API_URL2 =
        "https://script.google.com/macros/s/AKfycbzGvY_d-SkDz5_MHKuj0Xzcdi4sJAH6gWvgBg7RTcGIHKYlbltgA7J_il4bHdMPMifB/exec";

      const providersConfig = {
        telkomsel: {
          prefixes: [
            "0811",
            "0812",
            "0813",
            "0821",
            "0822",
            "0823",
            "0851",
            "0852",
            "0853",
          ],
          color: "bg-red-600",
        },
        indosat: {
          prefixes: ["0814", "0815", "0816", "0855", "0856", "0857", "0858"],
          color: "bg-yellow-400",
        },
        xl: {
          prefixes: ["0817", "0818", "0819", "0859", "0877", "0878"],
          color: "bg-blue-700",
        },
        axis: { prefixes: ["0831", "0832", "0838"], color: "bg-purple-600" },
        tri: {
          prefixes: ["0895", "0896", "0897", "0898", "0899"],
          color: "bg-orange-600",
        },
        smartfren: {
          prefixes: [
            "0881",
            "0882",
            "0884",
            "0885",
            "0886",
            "0887",
            "0888",
            "0889",
          ],
          color: "bg-pink-600",
        },
      };

      let allProducts = [];
      let currentTab = "masa aktif";
      let detectedProvider = null;
      let isLoading = false;
      let selectedProductData = null;

      const CACHE_DURATION = 60 * 60 * 1000;
      const CACHE_KEY_PREFIX = "reload_data_";

      function saveToCache(provider, data) {
        try {
          const cacheData = { timestamp: Date.now(), data: data };
          localStorage.setItem(
            `${CACHE_KEY_PREFIX}${provider}`,
            JSON.stringify(cacheData)
          );
        } catch (e) {
          console.error(e);
        }
      }

      function getFromCache(provider) {
        try {
          const cached = localStorage.getItem(`${CACHE_KEY_PREFIX}${provider}`);
          if (!cached) return null;
          const cacheData = JSON.parse(cached);
          if (Date.now() - cacheData.timestamp < CACHE_DURATION)
            return cacheData.data;
          return null;
        } catch (e) {
          return null;
        }
      }

      async function fetchProductsByProvider(provider) {
        if (!provider) return;
        const cachedData = getFromCache(provider);
        if (cachedData) {
          allProducts = cachedData;
          renderProducts();
          return;
        }
        isLoading = true;
        document.getElementById("loading-state").classList.remove("hidden");
        document.getElementById("empty-state").classList.add("hidden");
        document.getElementById("product-list").classList.add("hidden");
        try {
          const response = await fetch(
            `${API_URL}?provider=${encodeURIComponent(provider)}`
          );
          const result = await response.json();
          if (result.status === "ok") {
            allProducts = result.data || [];
            saveToCache(provider, allProducts);
            renderProducts();
          } else {
            showEmpty("Produk belum tersedia");
          }
        } catch (error) {
          showEmpty("Gagal mengambil data");
        } finally {
          document.getElementById("loading-state").classList.add("hidden");
          isLoading = false;
        }
      }

      function showEmpty(message) {
        const empty = document.getElementById("empty-state");
        const list = document.getElementById("product-list");
        empty.innerHTML = `<i class="fa-solid fa-box-open text-5xl mb-4 opacity-20"></i><p class="text-sm">${message}</p>`;
        empty.classList.remove("hidden");
        list.classList.add("hidden");
      }

      function switchTab(tab) {
        currentTab = tab;
        const btnMasa = document.getElementById("tab-masa-aktif");
        const btnPaket = document.getElementById("tab-paket-data");
        const btnPulsa = document.getElementById("tab-pulsa");
        const btnEmoney = document.getElementById("tab-emoney");
        if (tab === "masa aktif") {
          btnMasa.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-blue-600 text-blue-600 transition-all";
          btnPaket.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
          btnPulsa.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
         btnEmoney.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
            document.getElementById("phone-input-section").classList.remove("hidden");
            document.getElementById("emoney-page").classList.add("hidden");
        } else if (tab === "paket data") {
          btnPaket.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-blue-600 text-blue-600 transition-all";
          btnMasa.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
          btnPulsa.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
        btnEmoney.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
            document.getElementById("phone-input-section").classList.remove("hidden");
            document.getElementById("emoney-page").classList.add("hidden");
        } else if (tab === "pulsa") {
          btnPulsa.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-blue-600 text-blue-600 transition-all";
          btnMasa.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
          btnPaket.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
        btnEmoney.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
        document.getElementById("phone-input-section").classList.remove("hidden");
        document.getElementById("emoney-page").classList.add("hidden");
        } else if (tab === "emoney") {
          btnEmoney.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-blue-600 text-blue-600 transition-all";
          btnMasa.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
          btnPaket.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
          btnPulsa.className =
            "w-1/2 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 transition-all";
            document.getElementById("phone-input-section").classList.add("hidden");
            document.getElementById("emoney-page").classList.remove("hidden");
        }
        

        renderProducts();
      }
    //   let selectedProductData = null;
    //     let isLoading = false;
    //     let detectedProvider = "Emoney";
    const EMONEY_CACHE_KEY = "cache_emoney_data";
     const EMONEY_CACHE_TIME = 1000 * 60 * 30;

        function getCachedData() {
            const cached = localStorage.getItem(EMONEY_CACHE_KEY);
            if (cached) {
                const parsed = JSON.parse(cached);
                if (Date.now() - parsed.timestamp < EMONEY_CACHE_TIME) return parsed.data;
            }
            return null;
        }
      async function handleOperatorClick(operator) {
    document.getElementById('btn-grab').style.opacity = (operator === 'Grab Drive') ? '1' : '0.4';
    document.getElementById('btn-maxim').style.opacity = (operator === 'Maxim Driver') ? '1' : '0.4';

    const cached = getCachedData();
    if (cached) {
        renderEmoneyProducts(cached, operator);
    } else {
        await fetchAndRenderEmoney(operator);
    }
}
async function fetchAndRenderEmoney(operator) {
    console.log("Fetching data for operator:", operator);
    const loader = document.getElementById('loading-state');
    const productSec = document.getElementById('product-section');
    const emptySec = document.getElementById('empty-state');

    loader.classList.remove('hidden');
    productSec.classList.add('hidden');
    emptySec.classList.add('hidden');

    try {
        const response = await fetch(API_URL);
        const result = await response.json();
        if (result.status === "ok") {
            const emoneyData = result.data.filter(item => item.type === "Emoney");
            localStorage.setItem(EMONEY_CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data: emoneyData })); // Fixed cache key
            renderEmoneyProducts(emoneyData, operator);
        } else { 
            showError("Gagal memuat data"); 
        }
    } catch (error) { 
        showError("Koneksi bermasalah"); 
    }
    finally { 
        loader.classList.add('hidden'); 
    }
}

function renderEmoneyProducts(data, operator) {
    const grid = document.getElementById('product-grid');
    const productSec = document.getElementById('product-section');
    const inputSec = document.getElementById('input-section');
    const filtered = data.filter(p => p.operator === operator);
    
    grid.innerHTML = '';
    if (filtered.length === 0) { 
        showError("Produk tidak ditemukan"); 
        return; 
    }

    filtered.forEach(p => {
        const card = document.createElement('div');
        card.className = 'product-card p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition-all';
        card.innerHTML = `
            <div class="text-[10px] uppercase font-bold text-gray-500">${p.operator}</div>
            <div class="text-sm font-bold leading-tight my-2">${p.description}</div>
            <div class="text-lg font-bold text-blue-600">Rp ${parseFloat(p.price).toLocaleString('id-ID')}</div>
        `;
        card.onclick = () => selectEmoneyProduct(p);
        grid.appendChild(card);
    });

    productSec.classList.remove('hidden');
    inputSec.classList.remove('hidden'); // Show input section
    document.getElementById("promo-carousel").classList.add("hidden");
    document.getElementById("section-landing").classList.add("hidden");
}

function selectEmoneyProduct(product) {
    // Remove previous selection styling
    document.querySelectorAll('#product-grid .product-card').forEach(card => {
        card.classList.remove('border-blue-500', 'bg-blue-50');
        card.classList.add('border-gray-200');
    });
    
    // Add selection styling to clicked card
    event.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
    event.currentTarget.classList.remove('border-gray-200');
    
    // Store selected product
    selectedProductData = {
        description: product.description,
        price: product.price,
        formattedPrice: new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            maximumFractionDigits: 0,
        }).format(product.price),
        provider: product.operator,
        sku: product.SKU || "N/A",
        type: "emoney"
    };
}

function initiateCheckout() {
    const driverId = document.getElementById('driver-id').value;
    
    if (!driverId || driverId.length < 5) {
        alert('Masukkan ID Driver yang valid (minimal 5 digit)');
        return;
    }
    
    if (!selectedProductData) {
        alert('Pilih produk terlebih dahulu');
        return;
    }
    
    // Add driver ID to selected product data
    selectedProductData.phone = driverId;
    
    // Show confirmation overlay
    document.getElementById("selected-product-text").innerText = 
        `${selectedProductData.description} - ${selectedProductData.formattedPrice}\nID Driver: ${driverId}`;
    document.getElementById("confirm-view").classList.remove("hidden");
    document.getElementById("order-success-view").classList.add("hidden");
    document.getElementById("success-overlay").classList.remove("hidden");
}

function showError(message) {
    const empty = document.getElementById('empty-state');
    empty.innerHTML = `<i class="fa-solid fa-exclamation-circle text-5xl mb-4 opacity-20 text-red-400"></i><p class="text-sm text-red-500">${message}</p>`;
    empty.classList.remove('hidden');
}
        // function renderProducts(data, operator) {
        //     const grid = document.getElementById('product-grid');
        //     const productSec = document.getElementById('product-section');
        //     const inputSec = document.getElementById('input-section');
        //     const filtered = data.filter(p => p.operator === operator);
            
        //     grid.innerHTML = '';
        //     if (filtered.length === 0) { showError("Produk tidak ditemukan"); return; }

        //     filtered.forEach(p => {
        //         const card = document.createElement('div');
        //         card.className = 'product-card p-4 rounded-lg text-center flex flex-col justify-center items-center min-h-[100px] shadow-sm';
        //         card.innerHTML = `
        //             <div class="text-[10px] uppercase font-bold opacity-80">${p.operator}</div>
        //             <div class="text-sm font-bold leading-tight my-1">${p.description.toUpperCase()}</div>
        //             <div class="text-xs font-bold">RP. ${parseFloat(p.price).toLocaleString('id-ID')}</div>
        //         `;
        //         card.onclick = () => selectProduct(p, card);
        //         grid.appendChild(card);
        //     });

        //     productSec.classList.remove('hidden');
        //     inputSec.classList.add('hidden');
        // }

      function handlePhoneInput(val) {
        val = val.replace(/\D/g, "");
        document.getElementById("phone-number").value = val;
        renderProducts();
        if (val.length >= 4) {
          const prefix = val.substring(0, 4);
          let found = null;
          for (const [name, config] of Object.entries(providersConfig)) {
            if (config.prefixes.includes(prefix)) {
              found = name;
              break;
            }
          }
          if (found) {
            if (detectedProvider !== found) {
              detectedProvider = found;
              updateUIForProvider(found);
              fetchProductsByProvider(found);
            }
          } else {
            resetState("Prefix tidak dikenal");
          }
        } else {
          resetState("Masukkan nomor untuk melihat produk");
        }
      }

      function updateUIForProvider(name) {
        const info = document.getElementById("operator-info");
        const badge = document.getElementById("operator-badge");
        const config = providersConfig[name];
        info.innerHTML = `<span class="text-blue-600 font-bold">Operator Terdeteksi: ${name.toUpperCase()}</span>`;
        badge.innerText = name;
        badge.className = `ml-2 px-2 py-1 rounded text-[10px] font-bold text-white uppercase ${config.color}`;
        badge.style.display = "block";
      }

      function resetState(message) {
        detectedProvider = null;
        allProducts = [];
        document.getElementById("operator-badge").style.display = "none";
        document.getElementById("operator-info").innerText = message;
        showEmpty("Pilih provider dengan memasukkan nomor HP");
      }

      function renderProducts(data, operator, tabis)  {
        console.log("Rendering products for detected:", detectedProvider);
        console.log("Rendering products for operator:", operator);
        if (!detectedProvider || !allProducts.length) return;
        const container = document.getElementById("product-list");
        const empty = document.getElementById("empty-state");
        const phoneNumber = document.getElementById("phone-number").value;
        const isPhoneValid = phoneNumber.length >= 11;
        container.innerHTML = "";
        const filteredProducts = allProducts.filter(
          (p) =>
            String(p.operator || "")
              .toLowerCase()
              .trim() === detectedProvider.toLowerCase() &&
            String(p.type || "")
              .toLowerCase()
              .trim() === currentTab
        );
        if (!filteredProducts.length) {
          showEmpty("Produk belum tersedia");
          return;
        }
        filteredProducts.forEach((product) => {
          const card = document.createElement("div");
          card.className = `product-card bg-white border border-gray-100 rounded-xl p-4 flex justify-between items-center shadow-sm cursor-pointer hover:border-blue-300 ${
            !isPhoneValid ? "opacity-80" : ""
          }`;
          card.onclick = () => {
            if (document.getElementById("phone-number").value.length >= 11) {
              selectProduct(product);
            } else {
              const info = document.getElementById("operator-info");
              info.innerHTML = `<span class="text-red-500 font-bold animate-pulse">Lengkapi nomor HP (min. 11 digit)!</span>`;
              setTimeout(() => updateUIForProvider(detectedProvider), 2000);
            }
          };
          const formattedPrice = new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            maximumFractionDigits: 0,
          }).format(product.price);
          card.innerHTML = `<div><div class="flex items-center gap-2 mb-1"><span class="font-bold text-gray-800">${
            product.description
          }</span>${
            product.label
              ? `<span class="bg-blue-100 text-blue-600 text-[9px] px-2 py-0.5 rounded-full font-bold uppercase">${product.label}</span>`
              : ""
          }</div><span class="text-blue-600 font-bold text-sm">${formattedPrice}</span></div><i class="fa-solid fa-chevron-right text-gray-300 text-sm"></i>`;
          container.appendChild(card);
        });
        empty.classList.add("hidden");
        container.classList.remove("hidden");
        document.getElementById("promo-carousel").classList.add("hidden");
        document.getElementById("section-landing").classList.add("hidden");
      }

      function selectProduct(product) {
        const phoneNumber = document.getElementById("phone-number").value;
        const formattedPrice = new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          maximumFractionDigits: 0,
        }).format(product.price);
        selectedProductData = {
          phone: phoneNumber,
          description: product.description,
          price: product.price,
          formattedPrice: formattedPrice,
          provider: detectedProvider,
          sku: product.SKU || "N/A",
        };
        document.getElementById(
          "selected-product-text"
        ).innerText = `${product.description} - ${formattedPrice}`;
        document.getElementById("confirm-view").classList.remove("hidden");
        document.getElementById("order-success-view").classList.add("hidden");
        document.getElementById("success-overlay").classList.remove("hidden");
      }

      function generateOrderId() {
        const now = new Date();
        const timestamp = now.getTime().toString();
        // Generate a 9-digit suffix from timestamp and a random part
        const hash = timestamp.slice(-9) + Math.floor(Math.random() * 100);
        return "WO-" + hash.slice(0, 10);
      }

        async function sendToTelegram(data) {
          // Added backticks around ${data.phone}
          const message = `*Pesanan Baru*\n\nOrder ID: \`${data.orderId}\`
        Nomor: \`${data.phone}\`
        Produk: ${data.description}
        SKU: ${data.sku}
        Harga: ${data.formattedPrice}
        Provider: ${data.provider.toUpperCase()}`;
        
          try {
            await fetch(
              `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  chat_id: TELEGRAM_CHAT_ID,
                  text: message,
                  parse_mode: "Markdown", // This mode recognizes the backticks
                }),
              }
            );
          } catch (e) {
            console.error("Error sending to Telegram:", e);
          }
        }

      async function insertToSheet(data) {
        try {
          // Payload structure for Google Sheet insert
          const payload = {
            action: "insertOrder",
            nomor_tujuan: data.phone,
            kode_produk: data.sku,
            harga: data.price,
            nomor_order: data.orderId,
            status: "new",
          };

          await fetch(API_URL2, {
            method: "POST",
            mode: "no-cors", // Standard for simple Apps Script POST if not handling response
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          return true;
        } catch (e) {
          return false;
        }
      }

      async function processOrder() {
        if (!selectedProductData || isLoading) return;

        isLoading = true;
        const btn = document.getElementById("process-btn");
        btn.innerHTML =
          '<i class="fa-solid fa-circle-notch animate-spin mr-2"></i> Memproses...';
        btn.disabled = true;

        const orderId = generateOrderId();
        selectedProductData.orderId = orderId;

        // Run processes
        await Promise.all([
          //sendToTelegram(selectedProductData),
          insertToSheet(selectedProductData),
        ]);

        // Update UI to success view
        document.getElementById("confirm-view").classList.add("hidden");
        document
          .getElementById("order-success-view")
          .classList.remove("hidden");
        document.getElementById("display-order-id").innerText = orderId;

        isLoading = false;
        btn.innerHTML = "Lanjutkan";
        btn.disabled = false;
      }

      function redirectToWA() {
        if (!selectedProductData) return;
        const data = selectedProductData;
        const message = `Halo Aplus Digital, saya ingin bayar pesanan:\n\nOrder ID: ${data.orderId}\nNomor: ${data.phone}\nProduk: ${data.description}\nHarga: ${data.formattedPrice}`;
        const whatsappNumber = "6287862425338";
        window.open(
          `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`,
          "_blank"
        );
        closeOverlay();
      }

      function closeOverlay() {
        document.getElementById("success-overlay").classList.add("hidden");
        if (
          document
            .getElementById("order-success-view")
            .classList.contains("hidden")
        ) {
          // Only clear if we didn't finish an order
          selectedProductData = null;
        }
      }
      // Function to show the Detail Modal
      function showOrderDetail() {
        if (!selectedProductData) return;

        const data = selectedProductData;
        document.getElementById("det-id").innerText = data.orderId;
        document.getElementById("det-phone").innerText = data.phone;
        document.getElementById("det-product").innerText = data.description;
        document.getElementById("det-price").innerText = data.formattedPrice;

        const paymentArea = document.getElementById("det-payment-area");

        if (data.paymentUrl && data.paymentUrl.includes("http")) {
          paymentArea.innerHTML = `
            <a href="${data.paymentUrl}" target="_blank" class="block w-full bg-blue-600 text-white text-center py-4 rounded-xl font-bold shadow-lg">
                BAYAR SEKARANG
            </a>
            <p class="text-[10px] text-gray-400 text-center mt-2">Klik tombol di atas untuk membayar via QRIS/E-Wallet</p>
            `;
        } else {
          paymentArea.innerHTML = `
            <button onclick="redirectToWA()" class="w-full bg-green-500 text-white py-4 rounded-xl font-bold">
                BAYAR VIA WHATSAPP
            </button>
            `;
        }

        document.getElementById("detail-overlay").classList.remove("hidden");
      }

      function closeDetail() {
        document.getElementById("detail-overlay").classList.add("hidden");
      }

      // Update your existing insertToSheet to catch the link
      async function insertToSheet(data) {
        try {
          const payload = {
            action: "insertOrder",
            nomor_tujuan: data.phone,
            kode_produk: data.sku,
            harga: data.price,
            nomor_order: data.orderId,
            status: "new",
          };

          const response = await fetch(API_URL2, {
            method: "POST",
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          if (result.status === "ok" || result.payment_url) {
            // SAVE THE LINK TO OUR DATA
            selectedProductData.paymentUrl = result.payment_url;
            return true;
          }
          return false;
        } catch (e) {
          return false;
        }
      }
      // Scroll handler for fixed input section
function handleInputSectionScroll() {
  const inputSection = document.getElementById('input-section');
  const productSection = document.getElementById('product-section');
  const emoneyPage = document.getElementById('emoney-page');
  
  if (!inputSection || !productSection) return;
  
  // Get the original position of input section
  const scrollThreshold = 300; // Adjust this value (pixels from top)
  
  // Alternative: Use product section position
  // const scrollThreshold = productSection.offsetTop + 200;
  
  if (window.scrollY > scrollThreshold) {
    inputSection.classList.add('input-fixed');
    emoneyPage.classList.add('input-is-fixed');
  } else {
    inputSection.classList.remove('input-fixed');
    emoneyPage.classList.remove('input-is-fixed');
  }
}

// Add scroll event listener when page loads
window.addEventListener('scroll', handleInputSectionScroll);

// Also check on page load
window.addEventListener('load', handleInputSectionScroll);

// Enhanced Carousel Script with Swipe Support
let currentSlide = 0;
const slides = document.querySelectorAll('.carousel-item');
const dots = document.querySelectorAll('.carousel-dot');
const track = document.getElementById('carousel-track');
const carousel = document.getElementById('promo-carousel');
const totalSlides = slides.length;

function goToSlide(index) {
    currentSlide = (index + totalSlides) % totalSlides;
    track.style.transform = `translateX(-${currentSlide * 100}%)`;
    
    // Update dots
    dots.forEach((dot, i) => {
        if (i === currentSlide) {
            dot.classList.remove('bg-white/50');
            dot.classList.add('bg-white');
        } else {
            dot.classList.remove('bg-white');
            dot.classList.add('bg-white/50');
        }
    });
}

function nextSlide() {
    goToSlide(currentSlide + 1);
}

function prevSlide() {
    goToSlide(currentSlide - 1);
}

// Auto slide every 4 seconds
let autoSlideInterval = setInterval(nextSlide, 4000);

// Pause auto-slide on hover (desktop)
carousel.addEventListener('mouseenter', () => clearInterval(autoSlideInterval));
carousel.addEventListener('mouseleave', () => {
    autoSlideInterval = setInterval(nextSlide, 4000);
});

// Dot click handlers
dots.forEach(dot => {
    dot.addEventListener('click', () => {
        goToSlide(parseInt(dot.dataset.index));
        // Reset auto-slide timer
        clearInterval(autoSlideInterval);
        autoSlideInterval = setInterval(nextSlide, 4000);
    });
});

// ============================================
// MOBILE SWIPE SUPPORT
// ============================================
let touchStartX = 0;
let touchEndX = 0;
let touchStartY = 0;
let touchEndY = 0;

carousel.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
    // Pause auto-slide when user touches
    clearInterval(autoSlideInterval);
}, { passive: true });

carousel.addEventListener('touchmove', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
}, { passive: true });

carousel.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    
    const deltaX = touchStartX - touchEndX;
    const deltaY = Math.abs(touchStartY - touchEndY);
    
    // Only trigger swipe if horizontal movement is greater than vertical
    // This prevents interference with page scrolling
    if (Math.abs(deltaX) > deltaY) {
        // Swipe left (next slide)
        if (deltaX > 50) {
            nextSlide();
        }
        // Swipe right (previous slide)
        if (deltaX < -50) {
            prevSlide();
        }
    }
    
    // Resume auto-slide after swipe
    autoSlideInterval = setInterval(nextSlide, 4000);
}, { passive: true });

// Prevent default drag behavior on images
carousel.addEventListener('dragstart', (e) => {
    e.preventDefault();
});
    </script>
  

    <script src="https://cdn.jsdelivr.net/npm/flowbite@4.0.1/dist/flowbite.min.js"></script>

  </body>
</html>
